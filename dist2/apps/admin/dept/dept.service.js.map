{"version":3,"sources":["sourceMap"],"names":["__decorate","_0x2a77a4","_0xd32bf1","_0x27eda9","_0x5f5f58","_0x47614c","arguments","_0x42c442","Object","_0x411f09","Reflect","_0xdc23f","__metadata","_0x12e2df","_0x3a85f4","exports","common_1","require","date_helper_1","prisma_service_1","DeptService","constructor","_0x47e1d9","_0x1992e8","_0x24162e","parentDeptId","_0x416733","_0x12c99b","_0x5454d9","_0x11fecf","_0x28bd4d","_0x2c4775","_0x4aa6e2","_0x2baf1b","_0x3a254a","_0x2e75bb","_0x13e8b9","Map","_0x20f4fe","_0x3d385e","_0x3bbb87","_0x2a79dd","Set","_0x35e4dd","_0x1123da","_0x1063a7","_0x161fcb","_0x32892c","_0xabd2cc","Array","_0x3a62f9","_0x130d74","_0x185aca","_0x17963c","_0x1f08a2","_0x308f97","_0x2875b7","_0x18b350","console","_0x1d5ad1","_0x4592c2","_0x1fb2e7","_0x30c92c","_0x515ff0","_0xdd9d98"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DeptService = void 0;\nconst common_1 = require(\"@nestjs/common\");\nconst date_helper_1 = require(\"../../../common/helpers/date-helper\");\nconst prisma_service_1 = require(\"../../../common/prisma/prisma.service\");\nlet DeptService = class DeptService {\n    constructor(prisma) {\n        this.prisma = prisma;\n    }\n    async create(user, createDeptDto) {\n        const { parentDeptId, ...rest } = createDeptDto;\n        return this.prisma.dept.create({\n            data: {\n                ...rest,\n                ...(parentDeptId\n                    ? { parentDept: { connect: { id: parentDeptId } } }\n                    : {}),\n                corp: { connect: { id: user.corpId } },\n            },\n        });\n    }\n    async findOne(id) {\n        return this.prisma.dept.findUnique({\n            where: { id },\n        });\n    }\n    async update(id, updateDeptDto) {\n        return this.prisma.dept.update({\n            where: { id },\n            data: updateDeptDto,\n        });\n    }\n    async remove(id) {\n        return this.prisma.dept.delete({\n            where: { id },\n        });\n    }\n    async findAll(user, q) {\n        const allCorpDepts = await this.prisma.dept.findMany({\n            where: {\n                corpId: user.corpId,\n            },\n        });\n        if (!q) {\n            return allCorpDepts.map((dept) => ({\n                ...dept,\n                createdAt: (0, date_helper_1.fmtBy)(dept.createdAt, 'yyyy-MM-dd HH:mm:ss'),\n            }));\n        }\n        const deptMap = new Map(allCorpDepts.map((dept) => [dept.id, dept]));\n        const matchedDepts = allCorpDepts.filter((dept) => dept.name.includes(q));\n        const matchedDeptIds = new Set(matchedDepts.map((d) => d.id));\n        const parentDeptIds = new Set();\n        for (const dept of matchedDepts) {\n            let currentParentId = dept.parentDeptId;\n            while (currentParentId) {\n                parentDeptIds.add(currentParentId);\n                const parentDept = deptMap.get(currentParentId);\n                currentParentId = parentDept?.parentDeptId || null;\n            }\n        }\n        const resultDepts = [\n            ...matchedDepts,\n            ...Array.from(parentDeptIds)\n                .map((id) => deptMap.get(id))\n                .filter((dept) => !matchedDeptIds.has(dept.id)),\n        ];\n        return resultDepts\n            .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())\n            .map((dept) => ({\n            ...dept,\n            createdAt: (0, date_helper_1.fmtBy)(dept.createdAt, 'yyyy-MM-dd HH:mm:ss'),\n            isMatched: matchedDeptIds.has(dept.id),\n        }));\n    }\n    async findDeptTree(user) {\n        const depts = await this.prisma.dept.findMany({\n            where: {\n                corpId: user.corpId,\n            },\n            orderBy: {\n                sort: 'asc',\n            },\n        });\n        const tree = this.buildDeptTree(depts);\n        console.log(tree);\n        return tree;\n    }\n    buildDeptTree(depts, parentId = null) {\n        const tree = [];\n        for (const dept of depts) {\n            if (dept.parentDeptId === parentId) {\n                const children = this.buildDeptTree(depts, dept.id);\n                const node = {\n                    ...dept,\n                    createdAt: (0, date_helper_1.fmtBy)(dept.createdAt, 'yyyy-MM-dd HH:mm:ss'),\n                    ...(children.length ? { children } : {}),\n                };\n                tree.push(node);\n            }\n        }\n        return tree;\n    }\n};\nexports.DeptService = DeptService;\nexports.DeptService = DeptService = __decorate([\n    (0, common_1.Injectable)(),\n    __metadata(\"design:paramtypes\", [prisma_service_1.PrismaService])\n], DeptService);\n//# sourceMappingURL=dept.service.js.map"]}