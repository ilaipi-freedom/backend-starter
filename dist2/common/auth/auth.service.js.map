{"version":3,"sources":["sourceMap"],"names":["__createBinding","Object","_0x24a354","_0x429141","_0x48b398","_0x1b2998","undefined","_0x4d4373","_0x12da6c","_0x49a06d","_0x56d911","_0x128bc7","__setModuleDefault","_0x29a1c2","_0x3589fe","_0x2688b6","_0x57d273","__decorate","_0x333006","_0x10cd0c","_0x23c64d","_0x6b18b1","_0x1b0703","arguments","_0x388f30","_0x54ebca","Reflect","_0x4045b2","__importStar","_0x16d4c1","_0x391712","_0xecba5","__metadata","_0x4f3841","_0x1b5ffd","__param","_0x7bdafe","_0x899f26","_0x4870b0","_0x5a5db6","__importDefault","_0xc4d729","AuthService_1","exports","cache_manager_1","require","common_1","common_2","config_1","jwt_1","argon2","date_fns_1","ioredis_1","auth_helper_1","number_helper_1","prisma_service_1","AuthService","constructor","_0x2691e2","_0x5ee7f0","_0x428e41","_0x191cba","_0xecee2a","_0x5d4404","_0x53fd67","_0x18df44","_0x60aea1","_0xd7798","_0x35b1c9","_0x243471","_0x420e44","_0x30287e","_0x8a1876","Date","_0x58f31e","_0x47d948","_0x415c94","JSON","Number","_0x3ecbd2","_0x503783","_0x3e03b5","_0x22be60","_0x4b7496","_0x5c3173"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nvar __param = (this && this.__param) || function (paramIndex, decorator) {\n    return function (target, key) { decorator(target, key, paramIndex); }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nvar AuthService_1;\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.AuthService = void 0;\nconst cache_manager_1 = require(\"@nestjs/cache-manager\");\nconst common_1 = require(\"@nestjs/common\");\nconst common_2 = require(\"@nestjs/common\");\nconst config_1 = require(\"@nestjs/config\");\nconst jwt_1 = require(\"@nestjs/jwt\");\nconst argon2 = __importStar(require(\"argon2\"));\nconst date_fns_1 = require(\"date-fns\");\nconst ioredis_1 = __importDefault(require(\"ioredis\"));\nconst auth_helper_1 = require(\"../helpers/auth-helper\");\nconst number_helper_1 = __importDefault(require(\"../helpers/number-helper\"));\nconst prisma_service_1 = require(\"../prisma/prisma.service\");\nlet AuthService = AuthService_1 = class AuthService {\n    constructor(jwtService, cacheManager, prisma, configService) {\n        this.jwtService = jwtService;\n        this.cacheManager = cacheManager;\n        this.prisma = prisma;\n        this.configService = configService;\n        this.logger = new common_2.Logger(AuthService_1.name);\n        this.redis = new ioredis_1.default(configService.get('env.redis'));\n    }\n    async verifyAccount(username, pass) {\n        const account = await this.prisma.account.findUnique({\n            where: {\n                username,\n            },\n            include: {\n                role: true,\n            },\n        });\n        if (!account) {\n            this.logger.log({ username }, '用户不存在，登录失败');\n            throw new common_1.UnauthorizedException('登录失败!');\n        }\n        if (await argon2.verify(account.password, pass)) {\n            return account;\n        }\n        else {\n            this.logger.log({ username }, '密码错误，登录失败');\n            throw new common_1.UnauthorizedException('登录失败!');\n        }\n    }\n    async signIn(username, pass) {\n        const account = await this.verifyAccount(username, pass);\n        const type = await this.configService.get('env.appInstance');\n        const payload = { id: account.id, key: 'AUTH', type };\n        const sessionKey = auth_helper_1.AuthHelper.sessionKey(payload);\n        const token = await this.jwtService.signAsync(payload);\n        const now = (0, date_fns_1.subMinutes)(Date.now(), 1).getTime();\n        const tokenVerified = await this.jwtService.verifyAsync(token);\n        const ttl = number_helper_1.default.minus(tokenVerified.exp * 1000, now).toFixed(0);\n        const sessionParam = {\n            id: account.id,\n            type,\n            username: account.username,\n            token,\n            role: account.role.perm,\n            corpId: account.corpId,\n        };\n        await this.cacheManager.set(sessionKey, JSON.stringify(sessionParam), Number(ttl));\n        return {\n            id: account.id,\n            role: account.role.perm,\n            token,\n        };\n    }\n    async signOut(payload) {\n        const sessionKeyParam = { id: payload.id, key: 'AUTH', type: payload.type };\n        const sessionKey = auth_helper_1.AuthHelper.sessionKey(sessionKeyParam);\n        await this.cacheManager.del(sessionKey);\n    }\n    async validateUser(payload) {\n        const sessionKey = auth_helper_1.AuthHelper.sessionKey(payload);\n        const session = await this.cacheManager.get(sessionKey);\n        if (session) {\n            return JSON.parse(session);\n        }\n        throw new common_1.UnauthorizedException('登录已失效!');\n    }\n};\nexports.AuthService = AuthService;\nexports.AuthService = AuthService = AuthService_1 = __decorate([\n    (0, common_1.Injectable)(),\n    __param(1, (0, common_1.Inject)(cache_manager_1.CACHE_MANAGER)),\n    __metadata(\"design:paramtypes\", [jwt_1.JwtService, Object, prisma_service_1.PrismaService,\n        config_1.ConfigService])\n], AuthService);\n//# sourceMappingURL=auth.service.js.map"]}